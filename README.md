# api-facial-recognition

<p align="center"> 
  <img src="./utils_readme/images/macky_macron.png" width="640">
  <h3 align="center">
    A python flask(API) based on opencv and dlib that allows to build dynamic face recognizer models
  </h3>  
</p>

---
---

api-facial-recognition is developed by **Ibrahima BA** and I**brahima Gaye**, its goal is to provide a dynamic way to build facial recognizer deep learning model. We use a combination of **opencv** and **dlib facial landmarks** in the form of api **flask**. It allows users to send a bunch of images and retrieve a a model that can recognize faces instances that was previously sent. The building process is based on keras tensorflow, but we also add an optimizer process that can find the optimal topology of the network with the best accuracy. We use the evolutionary strategy named GA : Genetic Algorithm to achieve this goal. 

# contents
* [structure](#structure)
* [prerequisites](#prerequisites)
* [installation](#installation)
* [building](#building)
* [test](#test)
* [api && endpoints](#endpoints)

# structure

this project is structured in a modular way, it is linked to several libraries such as **[opencv, numpy, flask, zmq, loguru, multiprocessing]** 
It contains the :
* following directories:
    * app
        * flask init and views 
        * this is our api, it will allows users to access to our application 
        * link with the file run.py and app.ini
    * constants
        * usefull constants for flask server 
        * usefull constants for deep learning models
    * preprocessor
        * object oriented image processing class 
        * main object of the project 
        * allows to manipulate image and make several transformation
        * such as face detection, cropping, landmarks generator
    * features
        * is the target location where faces features will be stored 
        * the features are 128 vector generated by dlib   
    * logger
        * contains log formatting and settings
        * based on loguru 
    * modelization
        * contains the logic of building face recognizer models  
        * once the models was build, they will be stored to dumps 
    * optimization
        * contains the optimizer based on Genetic Programming
        * this optimizer will search the best topology of the neural network 
        * it will try to minimize the number of layer and maximize the accuracy 
        * this features is not required, the user can discard it during the request 
    * test
        * validates the behavior of descriptor
        * based on pytest and hypothesis 
    * utils_readme
        * contains some image, font for readme rendering 
        * can be easily extended by the user 
* following files
    * docker and gitlab confs
        * .dockerignore
        * .gitignore
        * .gitlab-ci.yml
        * Dockerfile
    * application core
        * app.ini (uwsgi conf) 
        * run.py
    * project libraries
        * requirements.txt 



# prerequisites
* git
* curl
* cmake 
* pkg-config 
* libatlas-base-dev 
* libboost-python-dev 
* libopenblas-dev 
* liblapack-dev
* python3
* python3-venv 
* build-essential
* uwsgi 
* ffmpeg (optional) 
* libpcre3 && libpcre3-dev (optional)

# installation
```bash
    git clone git clone https://github.com/Milkymap/api-facial-recognition.git
    cd api-facial-recognition
    git checkout -b develop 
    git pull origin develop 
    git checkout features/your_features_name
    python -m venv env 
    source env/bin/activate 
    pip install --upgrade pip 
    pip install -r requirements.txt 
```

# building

* with local python and uwsgi  
```bash  
    cd api-facial-recognition
    uwsgi --uid username --ini app.ini
```

* with docker 
```bash
    cd api-facial-recognition
    docker image build -f Dockerfile -t [your_image_name]:[your_image_tag] ./
    docker container run --name [your_container_name] --publish [your_port, choose 8080]:8080 --rm your_image_name:your_image_tag  
```

# test
```bash
    cd api-facial-recognition
    python -m pytest --hypothesis-show-statistics
```

# endpoints 
* **/is_alive**
    * this route allows us to know if the server is up or not 
    * it can be used in order to check the disponibility of the service
    * ```bash
        curl http://localhost:8080/is_alive
      ```
* **/build_recognizer**
    * this is the main route 
    * it is used for to build the model  
    * it take a bunch of images and render json with the following format 
    * ths status allows us to know if the data was received sucessfully 
    * if status is 0 => there is no error  
    * else, no need to check the other keys 
    * ```json
        {
            "status": "0 | 1",
            "id": "id of the model, the user will used it later to retrieve the model" 
        }
      ```
    * ```bash
        curl -F 'images=@path/to/images' http://localhost:8080/build_recognizer
      ```

* **/is_available**
    * this route allows to know if the model was build or not 
    * it is usefull because the building process of the model can take a certain amount of time 
    * so it is more simple to retrieve the model later or to get a notification once the model was built 
    * ```bash
        curl http://localhost:8080/is_available 
      ```
    * the response is the next json format 
    * ```json
        {
            "available": "0  | 1, 0 means not available, and 1 means the model was built and ready to be downloaded"  
        }
      ```